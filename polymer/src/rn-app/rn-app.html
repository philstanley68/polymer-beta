<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="stylesheet" type="text/css" href="./rn-beta.css">
<link rel="import" href="shared-styles.html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<dom-module id="rn-app">
  <template>
    <style include="shared-styles">
    :root {
      --color-primary: rgba(255, 79, 31, 1.0);
      --color-secondary: rgba(93, 62, 93, 1.0);
      --color-ltgray: rgba(211, 211, 212, 0.5);
      --color-mdgray: rgba(149, 150, 153, 1.0);
      --color-dkgray: rgba(78, 80, 84, 1.0);
      --color-white: rgba(255, 255, 255, 1.0);
      --color-black: rgba(0, 0, 0, 1.0);
      --color-tip: rgba(93, 62, 93, 1.0);
      --color-note: rgba(93, 62, 93, 1.0);
      --color-important: rgba(255, 79, 31, 1.0);
      --color-caution: rgba(255, 79, 31, 1.0);
      --color-warning: rgba(255, 79, 31, 1.0);
      font-family: "Roboto", sans-serif;
      font-size: 10.0pt;
    }
      app-header {
          background-color: var(--color-primary);
          color: var(--color-white);
          font-weight: bold;
        --app-header-background-rear-layer: {
          background-color: var(--color-secondary);
        }
      }
      app-drawer-layout {
        --app-drawer-width: 275px;
      }
      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }
      app-toolbar {
      }
      paper-checkbox.releases {
        padding: 2px 0px 2px 24px;
        --paper-checkbox-checked-color: var(--color-secondary);
        --paper-checkbox-size: 15px;
        --paper-checkbox-ink-size: 30px;
      }
      paper-checkbox.product-filter {
        font-size:8.0pt;
        padding: 2px 0px 2px 24px;
        --paper-checkbox-checked-color: var(--color-secondary);
        --paper-checkbox-size: 15px;
        --paper-checkbox-ink-size: 30px;
      }
      paper-icon-button {
        color: white;
        --paper-icon-button-ink-color: white;
      }
      paper-input {
        border: thin solid var(--color-mdgray);
        border-radius: 6px;
        margin: 6px;
        padding: 0 6px;
        --paper-input-container-color: var(--color-mdgray);
        --paper-input-container-focus-color: var(--color-secondary);
        --paper-input-container: {
          height: 24px;
          margin-bottom: 18px;
          margin-top: 0;
          padding-bottom:18px;
          padding-top: 0;
        }
      }
      a, a:link {
          color: rgb(255, 79, 31);
          text-decoration: underline;
      }
      a:visited {
        color: rgb(93, 62, 93);
      }
      a:hover {
          color: rgb(255,79,31);
      }
      h1 {
        display:none;
      }
      p.feature {
        font-size: 11.0pt;
        font-weight: bold;
        cursor: pointer;
        color: rgba(93, 62, 93, 1.0);
      }
      p.feature:hover {
        color: #ff4f1f;
      }
      p.release {
        font-size: 13.0pt;
        font-weight: bold;
        color:white;
        cursor: pointer;
      }
      p.release:hover {
        color: #5D3E5D;
      }
      .feature-card {
        margin: 6px;
        padding: 3px 10px 3px 10px;
        border-radius: 5px;
        background-color: white;
      }
      div.intro {
        width: 95%;
        margin-left:auto;
        margin-right:auto;
      }
      img.genesys-logo {
        margin-left: 36px;
        margin-top: 12px;
        height: 36px;
      }
      img.inappheader {
        height: 60px;
        margin: 0;
        padding: 0 12px;
        display: block;
        float: left;
      }
      .caution {
        border-left: 6px solid var(--color-caution);
        border-right: 6px solid var(--color-caution);
      }

      .caution:before {
        content: "Caution!";
        color: var(--color-caution);
      }

      .important {
        border-left: 6px solid var(--color-important);
        border-right: 6px solid var(--color-important);
      }

      .important:before {
        content: "Important!";
        color: var(--color-important);
      }

      .note {
        border-left: 6px solid var(--color-note);
        border-right: 6px solid var(--color-note);
      }

      .note:before {
        content: "Note:";
        color: var(--color-note);
      }

      .tip {
        border-left: 6px solid var(--color-tip);
        border-right: 6px solid var(--color-tip);
      }

      .tip:before {
        content: "Tip:";
        color: var(--color-tip);
      }

      .warning {
        border-left: 6px solid var(--color-warning);
        border-right: 6px solid var(--color-warning);
      }

      .warning:before {
        content: "Warning!";
        color: var(--color-warning);
      }

      .caution,
      .important,
      .note,
      .tip,
      .warning {
        background-color: var(--color-ltgray);
        border-radius: 6px;
        display: block;
        /*margin-left: 5%;
        margin-right: 5%;*/
        margin-left: auto;
        margin-right: auto;
        padding: 10px;
      }
      .caution:before,
      .important:before,
      .note:before,
      .tip:before,
      .warning:before {
        display: block;
        font-weight: bold;
        margin-bottom: 6px;
      }
    </style>

<!--
  http://localhost:9200/pureconnect_rn/_search?source={%22size%22:0,%22aggs%22:{%22releases%22:{%22terms%22:{%22field%22:%22release-date%22,%22size%22:50,%22order%22:{%22_term%22:%22desc%22}},%22aggs%22:{%22rels%22:{%22terms%22:{%22field%22:%22release.keyword%22,%22size%22:50,%22order%22:{%22_term%22:%22desc%22}},%22aggs%22:{%22top_feature_topics%22:{%22top_hits%22:{%22_source%22:{%22includes%22:[%22release-date%22,%22release%22,%22title%22,%22html%22]},%22size%22:50}}}}}}}}
 -->

    <iron-ajax
      id="es"
      auto
      method="GET"
      url=""
      handle-as="json"
      headers='{"Authorization": "Basic cGhpbGlwLnN0YW5sZXk6R2VuZXN5czEyMzQ="}'
      with-credentials="true"
      last-response="{{all_features}}">
    </iron-ajax>
    <iron-ajax
      id="pcrels"
      auto
      method="GET"
      url="https://ae8a80ae6362d7c25ca13fb7f79fc65c.us-east-1.aws.found.io:9243/pureconnect_rn/_search?source={%22size%22:0,%22aggs%22:{%22releases%22:{%22terms%22:{%22field%22:%22release-date%22,%22size%22:50,%22order%22:{%22_term%22:%22desc%22}},%22aggs%22:{%22rels%22:{%22terms%22:{%22field%22:%22release.keyword%22,%22size%22:50,%22order%22:{%22_term%22:%22desc%22}}}}}}}"
      handle-as="json"
      headers='{"Authorization": "Basic cGhpbGlwLnN0YW5sZXk6R2VuZXN5czEyMzQ="}'
      with-credentials="true"
      last-response="{{pcreleases}}">
    </iron-ajax>
    <iron-ajax
      id="prods"
      auto
      method="GET"
      url=""
      handle-as="json"
      headers='{"Authorization": "Basic cGhpbGlwLnN0YW5sZXk6R2VuZXN5czEyMzQ="}'
      with-credentials="true"
      last-response="{{products}}">
    </iron-ajax>

    <app-drawer-layout fullbleed>

      <app-drawer slot="drawer">
        <div style="height: 100%;overflow-x:auto;">
          <img class="genesys-logo" src="/src/rn-app/genesys-logo.svg"/>
          <iron-a11y-keys id="searchkey" target="[[target]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
          <paper-input id="searchinput" label="Search" value="{{userInput::input}}">
            <iron-icon icon="search" slot="prefix"></iron-icon>
          </paper-input>
          <div style="text-align:center;background-color:var(--color-secondary);color:var(--color-white);height:56px;padding-top:6px;">
            <div>Use full-text <strong>Search</strong> above</div>
            <div> OR </div>
            <div><strong>Release</strong> and <strong>Product</strong> filters below</div>
          </div>
          <app-toolbar>Release filters</app-toolbar>
          <paper-checkbox id="reltoggle" class="releases" on-change="checkboxChanged" checked={{checked}}>Select all</paper-checkbox><br/>
          <dom-repeat items="[[pcreleases.aggregations.releases.buckets]]" as="dateitem" indexAs="dateindex">
            <template>
              <dom-repeat items="[[dateitem.rels.buckets]]" as="releaseitem" indexAs="releaseindex">
                <template>
                  <paper-checkbox id$=rel_[[releaseitem.key]] class="releases" on-change="checkboxChanged" checked$={{checked}}>[[releaseitem.key]]</paper-checkbox><br/>
                </template>
              </dom-repeat>
            </template>
          </dom-repeat>
          <app-toolbar>Product filters</app-toolbar>
          <dom-repeat items="[[products.aggregations.products.buckets]]" as="productitem" indexAs="productindex">
            <template>
              <paper-checkbox id$=prod_[[productitem.key]] class="product-filter" on-change="prodfilter" checked>[[productitem.key]]</paper-checkbox><br/>
            </template>
          </dom-repeat>
        </div>
      </app-drawer>

      <app-header-layout>

        <app-header slot="header" style="height: 100px;" condenses fixed effects="material">
          <app-toolbar style="height: 100px;padding:0;margin:0;">
            <paper-icon-button icon="menu" title="menu" drawer-toggle></paper-icon-button>
            <div main-title>
              <img src="/src/rn-app/pureconnect.svg" alt="" class="inappheader"/>
              <p>PureConnect Release Notes prototype</p>
            </div>
          </app-toolbar>
        </app-header>

        <div class="card" style="background-color:#ff4f1f;">
          <p id="intro" class="release" on-click="toggleiron">Introduction</p>
          <iron-collapse id="ironintro" opened="true">
            <div class="feature-card">
              <p>
                The CIC Release Notes outlines most of the key new features introduced in CIC 4.0, CIC 2015, CIC 2016 and CIC 2017. It presents the features in order from the newest (the latest CIC 2017 release) to the oldest (CIC 4.0 GA). Following the CIC feature descriptions, the <strong> Separately Released Products </strong> section describes products that Genesys releases outside the PureConnect release cycle. The <a href="Product_Notices.htm" target="_blank" title="Opens the Product Notices in a new tab"> Product Notices </a>  section contains notifications about changes in sales and support status for Genesys products, or third party products.
              </p>
              <p class="note">
                See also <cite> <a href="http://help.genesys.com/cic/mergedProjects/wh_sfcic/desktop/release_notes_cic4sf.htm" target="_blank"> CIC for Salesforce Release Notes </a> </cite> and <cite> <a href="http://help.genesys.com/cic/mergedProjects/wh_sfcic/desktop/what_s_new_in_cic_for_salesforce.htm" target="_blank"> What's new in CIC for Salesforce </a> </cite>.
              </p>
              <p>
                  For a webinar presentation about new features introduced in recent CIC releases, see the <a href="https://my.inin.com/products/selfhelp/Webinars/Pages/default.aspx" target="_blank" title="Opens the Webinars page in the Support site"> Webinars page </a>  in the <strong> Self Help </strong> section of the Support site (requires credentials).
              </p>
              <p>
                For a printable PDF version of the Release Notes, see the <a href="https://help.genesys.com/cic/desktop/printable_documentation.htm" target="_blank" title="Opens the Printable Documentation page in a new tab"> Printable Documentation page </a>.
              </p>
              <p>
                The focus of this document is on the key features in each release. This document does not describe less significant features and other minor changes and bug fixes; however, documentation for those changes is available in the <a href="https://help.genesys.com/cic" target="_blank"> PureConnect Documentation Library </a> . In addition, each release and each patch release includes a system-generated Readme and Summary file that includes a detailed list of public changes that are included in the release. Those files are available on the Product Information site next to the release/patch download file (requires credentials): <a href="https://my.inin.com/products/Pages/Downloads.aspx"> https://my.inin.com/products/Pages/Downloads.aspx </a>
              </p>
            </div>
          </iron-collapse>
        </div>

        <dom-repeat items="[[all_features.aggregations.releases.buckets]]" as="dateitem" indexAs="dateindex">
          <template>
            <dom-repeat items="[[dateitem.rels.buckets]]" as="releaseitem" indexAs="releaseindex">
              <template>
                <div class="card" style="background-color:#ff4f1f;">
                  <p class="release" on-click="toggleiron">[[releaseitem.key]]</p>
                  <iron-collapse class="ironrel" id$=ironrelitem[[releaseindex]] opened="true">
                    <dom-repeat items="[[releaseitem.top_feature_topics.hits.hits]]" as="featureitem" indexAs="featureindex">
                      <template>
                        <div class="feature-card" id$="featureitem[[featureindex]]">
                          <p class="feature" on-click="toggleiron">[[featureitem._source.title]]</p>
                          <iron-collapse class="ironfeat" id$="ironfeatitem[[featureitem]]">
                            <div inner-h-t-m-l="[[featureitem._source.html]]">
                            </div>
                          </iron-collapse>
                        </template>
                      </dom-repeat>
                    </div>
                  </iron-collapse>
                </div>
              </template>
            </dom-repeat>
          </template>
        </dom-repeat>

      </app-header-layout>

    </app-drawer-layout>

  </template>

  <script>
    class RnApp extends Polymer.Element {
      toggleiron(event) {
        if (event.currentTarget.nextElementSibling.opened == false) {
          event.currentTarget.nextElementSibling.opened = true;
        } else {
          event.currentTarget.nextElementSibling.opened = false;
        }
      }
      static get is() { return 'rn-app'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'rn-app'
          },
          userInput: {
            type: String,
            notify: true,
          },
          target: {
            type: Object
          }
        };
      }
      onEnter() {
        var searchstr = this.userInput;
        var urlbase = "https://ae8a80ae6362d7c25ca13fb7f79fc65c.us-east-1.aws.found.io:9243/pureconnect_rn/_search?";
        if (searchstr.indexOf("\"") !== -1){
          searchstr = searchstr.replace(/\"/g,"\\\"");
        }
        searchstr = "\""+searchstr+"\"";
        var uristr = "";
        uristr = "source={\"size\":0,\"query\":{\"query_string\":{\"query\":"+searchstr+",\"fields\":[\"html\",\"title\"]}},\"highlight\":{\"pre_tags\":[\"<em>\",\"<b>\"],\"post_tags\":[\"</b>\",\"</em>\"],\"fields\":{\"html\":{\"number_of_fragments\":0}}},\"highlight\":{\"pre_tags\":[\"<em>\",\"<b>\"],\"post_tags\":[\"</b>\",\"</em>\"],\"fields\":{\"html\":{\"number_of_fragments\":0}}},\"aggs\":{\"releases\":{\"terms\":{\"field\":\"release-date\",\"size\":50,\"order\":{\"_term\":\"desc\"}},\"aggs\":{\"rels\":{\"terms\":{\"field\":\"release.keyword\",\"size\":50,\"order\":{\"_term\":\"desc\"}},\"aggs\":{\"top_feature_topics\":{\"top_hits\":{\"_source\":{\"includes\":[\"release-date\",\"release\",\"title\",\"html\"]},\"highlight\":{\"fields\":{\"html\":{}}},\"size\":50}}}}}}}}";
        uristr = urlbase + uristr;
        this.shadowRoot.querySelector("iron-ajax#es").url = uristr;
        this.shadowRoot.querySelector("iron-collapse#ironintro").opened = false;
        var ironrelsall = this.shadowRoot.querySelectorAll("iron-collapse.ironrel");
        for(var r=0;r<ironrelsall.length;r++){
          ironrelsall[r].opened = true;
        }
        // this.shadowRoot.querySelectorAll("iron-collapse.ironrel").opened = true;
        this.shadowRoot.querySelector("iron-ajax#prods").url = "";
        var chkall = this.shadowRoot.querySelectorAll("paper-checkbox");
        for (var i=0;i < chkall.length;i++){
          chkall[i].checked = false;
        }
      }
      // toggle(e) {
      //   if (e.target.nextElementSibling.style.display == "none") {
      //     e.target.nextElementSibling.style.display = "";
      //   } else {
      //     e.target.nextElementSibling.style.display = "none";
      //   }
      // }
      checkboxChanged(event) {
        var searchfield = this.shadowRoot.querySelector("paper-input#searchinput");
        searchfield.value="";
        /* Handle 'Select all' functionality */
        if(event.target.checked != true && event.target.id != "reltoggle"){
          var chkrelall = this.shadowRoot.querySelector("paper-checkbox#reltoggle");
          chkrelall.set("checked", false);
        }
        /* Get all checked paper-checkbox elements */
        var elems = this.shadowRoot.querySelectorAll("paper-checkbox.releases[checked]");
        /* Iterate through the checked paper-checkbox elements to create a
           new ElasticSearch query that includes the aggregations. */
        if(elems.length > 0){
          var temprels = "";
          for(var i=0; i < elems.length; i++){
            // console.log(elems[i].innerText);
            if(temprels == ""){
              temprels = "\"" + elems[i].innerText + "\"";
            }
            else {
              temprels = temprels + "," + "\"" + elems[i].innerText + "\"";
            }
          }
          temprels = "["+temprels+"]";
          var uribase = "https://ae8a80ae6362d7c25ca13fb7f79fc65c.us-east-1.aws.found.io:9243/pureconnect_rn/_search?";
          var uristr = uribase +"source={\"size\":0,\"query\":{\"terms\":{\"release.keyword\":"+temprels+"}},\"aggs\":{\"releases\":{\"terms\":{\"field\":\"release-date\",\"size\":50,\"order\":{\"_term\":\"desc\"}},\"aggs\":{\"rels\":{\"terms\":{\"field\":\"release.keyword\",\"size\":50,\"order\":{\"_term\":\"desc\"}},\"aggs\":{\"top_feature_topics\":{\"top_hits\":{\"_source\":{\"includes\":[\"release-date\",\"release\",\"title\",\"html\"]},\"size\":50}}}}}}}}";
          var uriprodstr = uribase + "source={\"size\":0,\"query\":{\"terms\":{\"release.keyword\":"+temprels+"}},\"aggs\":{\"products\":{\"terms\":{\"field\":\"product.keyword\",\"size\":100,\"order\":{\"_term\":\"asc\"}}}}}";
          this.shadowRoot.querySelector("iron-ajax#es").url = uristr;
          this.shadowRoot.querySelector("iron-ajax#prods").url = uriprodstr;
          this.shadowRoot.querySelector("iron-collapse#ironintro").opened = false;
        }
        else {
          /* Code to set the ElasticSearch query to nothing if no check boxes
           are selected */
          this.shadowRoot.querySelector("iron-collapse#ironintro").opened = true;
          this.shadowRoot.querySelector("iron-ajax#es").url = "";
          this.shadowRoot.querySelector("iron-ajax#prods").url = "";
        }
      }
      prodfilter(chk) {
        var prodchks = this.shadowRoot.querySelectorAll("paper-checkbox.product-filter[checked]");
        var relchks = this.shadowRoot.querySelectorAll("paper-checkbox.releases[checked]");
        var uristr = "https://ae8a80ae6362d7c25ca13fb7f79fc65c.us-east-1.aws.found.io:9243/pureconnect_rn/_search?";
        var tempprods = "";
        var temprels = "";
        if(prodchks.length > 0) {
          for(var i=0; i < relchks.length; i++) {
            if(temprels == ""){
              temprels = "\"" + relchks[i].innerText + "\"";
            } else {
              temprels = temprels + "," + "\"" + relchks[i].innerText + "\"";
            }
          }
          temprels = "["+temprels+"]";

          for(var i=0; i < prodchks.length; i++) {
            if(tempprods == ""){
              tempprods = "\"" + prodchks[i].innerText + "\"";
            } else {
              tempprods = tempprods + "," + "\"" + prodchks[i].innerText + "\"";
            }
          }
          tempprods = "["+tempprods+"]";

          uristr = uristr + "source={\"size\":0,\"query\":{\"bool\":{\"must\":[{\"terms\":{\"release.keyword\":"+temprels+"}},{\"terms\":{\"product.keyword\":"+tempprods+"}}]}},\"aggs\":{\"releases\":{\"terms\":{\"field\":\"release-date\",\"size\":50,\"order\":{\"_term\":\"desc\"}},\"aggs\":{\"rels\":{\"terms\":{\"field\":\"release.keyword\",\"size\":50,\"order\":{\"_term\":\"desc\"}},\"aggs\":{\"top_feature_topics\":{\"top_hits\":{\"_source\":{\"includes\":[\"release-date\",\"release\",\"title\",\"html\"]},\"size\":50}}}}}}}}";
          this.shadowRoot.querySelector("iron-ajax#es").url = uristr;
        } else {
        /* Code to modify the query so that no topics are shown. */
        }
      }
    }

    window.customElements.define(RnApp.is, RnApp);
  </script>

 </dom-module>
